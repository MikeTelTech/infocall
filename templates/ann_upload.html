{% extends "base.html" %}

{% block title %}Upload Announcements | InfoCall{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Manage Announcements</h1>
        <p class="text-gray-600">Upload audio announcements for your call campaigns</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="glass-card p-6 lg:col-span-1">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Upload New Announcement</h2>

            <form id="upload-form" enctype="multipart/form-data" method="post" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Audio File
                    </label>
                    <div class="flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-indigo-300 transition-colors duration-150">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto icon-lg text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-gray-600">
                                <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500 transition-colors duration-150">
                                    <span>Upload a file</span>
                                    <input id="file-upload" name="file" type="file" class="sr-only" accept=".mp3,.wav,.m4a,.aac" required>
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500">
                                .mp3 .wav .m4a .aac
                            </p>
                        </div>
                    </div>
                    <p id="file-name" class="mt-2 text-sm text-gray-500"></p>
                </div>

                <div class="pt-2">
                    <button id="upload-button" type="submit" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-150 transform hover:-translate-y-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                        Upload Announcement
                    </button>
                </div>
                <div id="uploading-message" class="text-center text-indigo-600 font-medium hidden" style="display: none;">
                    <div class="flex justify-center items-center">
                        <svg class="animate-spin -ml-1 mr-3 icon-sm text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Uploading...
                    </div>
                </div>
            </form>

            <div class="mt-6">
                <a href="{{ url_for('call.sync_announcements') }}" class="text-sm text-indigo-600 hover:text-indigo-900 transition-colors duration-150 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Sync Announcements Database
                </a>
            </div>
        </div>

        <div class="glass-card p-6 lg:col-span-2">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Your Announcements</h2>

            {% if announcements %}
                <div class="overflow-hidden border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Filename
                                </th>
                                {% if 'upload_date' in announcements[0] %}
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Upload Date
                                </th>
                                {% endif %}
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for announcement in announcements %}
                            <tr class="hover:bg-gray-50 transition-colors duration-150">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    <div class="flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm text-indigo-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                        </svg>
                                        {% if announcement is mapping %}
                                            {{ announcement.filename }}
                                        {% else %}
                                            {{ announcement[0] }}
                                        {% endif %}
                                    </div>
                                </td>
                                {% if 'upload_date_str' in announcement %}
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ announcement.upload_date_str }}
                                </td>
                                {% endif %}
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <a href="{{ url_for('call.delete_file', filename=announcement.filename if announcement is mapping else announcement[0]) }}"
                                       class="text-red-600 hover:text-red-900 ml-4 transition-colors duration-150 group"
                                       onclick="return confirm('Are you sure you want to delete this announcement?')">
                                        <span class="flex items-center justify-end">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm mr-1 transition-transform group-hover:rotate-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                            Delete
                                        </span>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 flex justify-between items-center">
                    <div class="text-sm text-gray-700">
                        Showing page {{ page }} of {{ total_pages }}
                    </div>
                    <div class="flex space-x-2">
                        {% if prev_page %}
                            <a href="{{ url_for('call.ann_upload', page=page-1) }}" class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-150 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                </svg>
                                Previous
                            </a>
                        {% endif %}
                        {% if next_page %}
                            <a href="{{ url_for('call.ann_upload', page=page+1) }}" class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-150 flex items-center">
                                Next
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm ml-1" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="text-center py-10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto icon-lg text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No announcements</h3>
                    <p class="mt-1 text-sm text-gray-500">Get started by uploading an audio file.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %} {# ADD THIS LINE TO CLOSE THE CONTENT BLOCK #}

<style>
    /* Enhanced glass card */
    .glass-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow:
            0 8px 32px 0 rgba(31, 38, 135, 0.1),
            0 2px 8px 0 rgba(31, 38, 135, 0.05);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    /* Table styling */
    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    tr {
        transition: background-color 0.2s ease;
    }

    /* Upload area animations */
    .border-dashed {
        transition: all 0.3s ease;
    }

    .border-dashed:hover {
        border-color: var(--primary-color);
        background-color: rgba(79, 70, 229, 0.05);
    }

    /* File upload label animations */
    input[type="file"] + label {
        transition: all 0.3s ease;
    }

    /* Button animations */
    button, a {
        transition: all 0.3s ease;
    }

    button:hover, a:hover {
        transform: translateY(-1px);
    }

    /* Icon animations in group hover context */
    .group:hover svg {
        color: currentColor;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .px-6 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        th, td {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
    }
</style>

{% block extra_js %}
<script>
    // Ensure uploads are properly tracked
    document.addEventListener('DOMContentLoaded', function() {
        // Immediately force hide the uploading message when page loads
        const uploadingMessage = document.getElementById('uploading-message');
        if (uploadingMessage) {
            uploadingMessage.classList.add('hidden');
            uploadingMessage.style.display = 'none';
        }

        const fileInput = document.getElementById('file-upload');
        const fileNameDisplay = document.getElementById('file-name');
        const dropZone = fileInput.closest('.border-dashed');
        const uploadForm = document.getElementById('upload-form');
        const uploadButton = document.getElementById('upload-button');

        // Completely rewritten form submission handling
        if (uploadForm && uploadButton) {
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Always prevent default to handle it manually

                if (fileInput && fileInput.files.length > 0) {
                    // Show loading state on button
                    uploadButton.disabled = true;
                    uploadButton.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Uploading...';

                    // Show the uploading message
                    if (uploadingMessage) {
                        uploadingMessage.classList.remove('hidden');
                        uploadingMessage.style.display = 'block';
                    }

                    // Use a small timeout to ensure UI updates before form submission
                    setTimeout(() => {
                        // Actually submit the form
                        uploadForm.submit();
                    }, 100);
                } else {
                    alert('Please select a file to upload.');
                }
            });
        }

        // File selection feedback
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const fileName = e.target.files[0].name;
                    fileNameDisplay.textContent = 'Selected file: ' + fileName;
                    fileNameDisplay.classList.add('text-indigo-600', 'font-medium');

                    // Add visual feedback
                    dropZone.classList.add('border-indigo-300', 'bg-indigo-50');
                } else {
                    fileNameDisplay.textContent = '';
                    dropZone.classList.remove('border-indigo-300', 'bg-indigo-50');
                }
            });
        }

        // Add drag and drop support
        if (dropZone) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Visual feedback for drag events
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropZone.classList.add('border-indigo-300', 'bg-indigo-50');
            }

            function unhighlight() {
                dropZone.classList.remove('border-indigo-300', 'bg-indigo-50');
            }

            // Handle file drop
            dropZone.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    fileInput.files = files;
                    fileNameDisplay.textContent = 'Selected file: ' + files[0].name;
                    fileNameDisplay.classList.add('text-indigo-600', 'font-medium');
                }
            }
        }
    });

    // Extra safety: force reset any state when navigating away
    window.addEventListener('beforeunload', function() {
        const uploadingMessage = document.getElementById('uploading-message');
        if (uploadingMessage) {
            uploadingMessage.classList.add('hidden');
            uploadingMessage.style.display = 'none';
        }
    });
</script>
{% endblock %}