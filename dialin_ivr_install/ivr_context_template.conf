; --- BEGIN INFOCALL IVR RECORDING CONTEXT ---
; ========================================================================
; START InfoCall IVR Recording Feature additions (REVISED - AGI CENTRIC)
; ADD TO entension_custom.conf located in /etc/asterisk
; relies on 3 agi files located in /var/lib/asterisk/agi-bin/
; ivr_handler.agi   lookup_user_for_ivr.agi    check_passcode.agi
; ========================================================================

[infocall-ivr-recording] ; New dedicated context for the IVR entry point
exten = __IVR_EXTENSION__,1,NoOp(== Routing call to InfoCall IVR Recording Authentication ==)
exten = __IVR_EXTENSION__,n,Answer()
exten = __IVR_EXTENSION__,n,Wait(1)
; --- Perform Authentication First (Using your existing AGIs) ---
exten = __IVR_EXTENSION__,n,Set(CALLER_NUM=${CALLERID(num)})
exten = __IVR_EXTENSION__,n,AGI(/var/lib/asterisk/agi-bin/lookup_user_for_ivr.agi,${CALLER_NUM})
exten = __IVR_EXTENSION__,n,NoOp(Lookup Result: AUTH_STATUS=${AUTH_STATUS}, AUTH_USER_ID=${AUTH_USER_ID}, HASH_PRESENT=${IF($[${LEN(${EXPECTED_HASH})} > 0]?Yes:No)})
exten = __IVR_EXTENSION__,n,GotoIf($["${AUTH_STATUS}" != "FOUND"]?auth_fail) ; SIMPLIFIED LINE
; Ask for passcode (using Background allows interruption)
exten = __IVR_EXTENSION__,n,Set(TIMEOUT(digit)=7)
exten = __IVR_EXTENSION__,n,Set(TIMEOUT(response)=10)
exten = __IVR_EXTENSION__,n,Playback(custom/infocall-enter-passcode) ; "Please enter your passcode"
exten = __IVR_EXTENSION__,n,Read(ENTERED_PASSCODE,,6) ; Read up to 6 digits
exten = __IVR_EXTENSION__,n,AGI(/var/lib/asterisk/agi-bin/check_passcode.agi,${ENTERED_PASSCODE},${EXPECTED_HASH})
exten = __IVR_EXTENSION__,n,NoOp(Passcode Check Result: ${AUTH_RESULT})
exten = __IVR_EXTENSION__,n,GotoIf($["${AUTH_RESULT}" = "OK"]?auth_success:auth_fail) ; SIMPLIFIED LINE

; --- Authentication Success: Call the main IVR handler AGI ---
exten = __IVR_EXTENSION__,n(auth_success),NoOp(Authentication successful for user ${AUTH_USER_ID}. Starting IVR handler.)
; Pass the authenticated user ID as an argument
exten = __IVR_EXTENSION__,n,AGI(/var/lib/asterisk/agi-bin/ivr_handler.agi,${AUTH_USER_ID})
exten = __IVR_EXTENSION__,n,Hangup() ; Hangup after the main AGI script finishes

; --- Authentication Failure ---
exten = __IVR_EXTENSION__,n(auth_fail),NoOp(Authentication failed. Status: ${AUTH_STATUS}, Result: ${AUTH_RESULT})
exten = __IVR_EXTENSION__,n,Playback(custom/infocall-unauth-caller) ; "Authentication failed, goodbye"
exten = __IVR_EXTENSION__,n,Hangup()

; Make sure the h extension exists somewhere accessible for cleanup if needed
; This basic one logs the hangup cause. You might add DB cleanup here if the DB approach was used.
exten = h,1,NoOp(Generic h extension: Hanging up call. Cause: ${HANGUPCAUSE} - ${HANGUPCAUSE_KEYS})
exten = h,n,Hangup()

; End of InfoCall IVR changes
; ==============================================
; --- END INFOCALL IVR RECORDING CONTEXT ---